!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var i,o="wss://twitro.com",r=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{d(i.next(e))}catch(e){r(e)}}function c(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}d((i=i.apply(e,t||[])).next())}))};class s{constructor(e,t){this.pcs=new Map,this.connected=!1,this.myScreen=e,this.endpoint=(null==t?void 0:t.SignalingServerEndpoint)||o}getUserMedia(){return r(this,void 0,void 0,(function*(){if(!this.stream){const e=yield navigator.mediaDevices.getUserMedia({audio:!0,video:{width:{max:640},height:{max:480},frameRate:{max:20}}});this.stream=e,this.myScreen.srcObject=e,this.myScreen.volume=0}}))}createNewPeer(e){return r(this,void 0,void 0,(function*(){const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]});this.pcs.set(e,t),yield this.getUserMedia();for(const e of this.stream.getTracks())t.addTrack(e,this.stream);return"ontrack"in t?t.ontrack=t=>r(this,void 0,void 0,(function*(){this.onTrack(e,t.streams[0])})):t.onaddstream=t=>r(this,void 0,void 0,(function*(){this.onTrack(e,t.stream)})),t}))}joinRoom(e){return r(this,void 0,void 0,(function*(){try{yield this.getUserMedia()}catch(e){return void alert("カメラの使用が許可されていないか、対応していないブラウザです")}return new Promise((t,n)=>{this.ws=new WebSocket(this.endpoint+"/connect"),this.ws.onmessage=e=>r(this,void 0,void 0,(function*(){this.handleMessage(JSON.parse(e.data))})),this.ws.onopen=n=>{this.connected=!0,this.ws.send(JSON.stringify({type:"join",payload:{room_id:e}})),t()}})}))}handleMessage(e){return r(this,void 0,void 0,(function*(){switch(e.type){case i.NotifyClientId:this.handleMessageNotifyClientId(e.payload);break;case i.NewClient:this.handleNewClient(e.payload);break;case i.LeaveClient:this.handleLeaveClient(e.payload);break;case i.Offer:yield this.handleMessageOffer(e.payload);break;case i.Answer:yield this.handleMessageAnswer(e.payload)}}))}handleMessageNotifyClientId(e){this.clientId=e.client_id}handleNewClient(e){return r(this,void 0,void 0,(function*(){const t=e.client_id,n=yield this.createNewPeer(t);yield this.createOffer(t),n.onicecandidate=e=>r(this,void 0,void 0,(function*(){e.candidate||this.sendOffer(t)}))}))}handleLeaveClient(e){return r(this,void 0,void 0,(function*(){const t=e.client_id;this.pcs.get(t).close(),this.pcs.delete(t),this.onLeave(t)}))}createOffer(e){return r(this,void 0,void 0,(function*(){const t=this.pcs.get(e),n=yield t.createOffer();yield t.setLocalDescription(n)}))}sendOffer(e){return r(this,void 0,void 0,(function*(){const t=this.pcs.get(e);this.ws.send(JSON.stringify({type:i.Offer,payload:{sdp:t.localDescription.sdp,client_id:e}}))}))}handleMessageOffer(e){return r(this,void 0,void 0,(function*(){const t=e.client_id,n=yield this.createNewPeer(t);n.onicecandidate=e=>r(this,void 0,void 0,(function*(){e.candidate||this.sendAnswer(t)})),yield n.setRemoteDescription({type:"offer",sdp:e.sdp}),yield this.createAnswer(t)}))}createAnswer(e){return r(this,void 0,void 0,(function*(){const t=this.pcs.get(e),n=yield t.createAnswer();yield t.setLocalDescription(n)}))}sendAnswer(e){const t=this.pcs.get(e);this.ws.send(JSON.stringify({type:i.Answer,payload:{sdp:t.localDescription.sdp,client_id:e}}))}handleMessageAnswer(e){return r(this,void 0,void 0,(function*(){const t=this.pcs.get(e.client_id);yield t.setRemoteDescription({type:"answer",sdp:e.sdp})}))}}!function(e){e.NotifyClientId="notify-client-id",e.NewClient="new-client",e.LeaveClient="leave-client",e.Error="error",e.Offer="offer",e.Answer="answer"}(i||(i={}));var c=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{d(i.next(e))}catch(e){r(e)}}function c(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}d((i=i.apply(e,t||[])).next())}))};new Map;const d=document.querySelector("#join"),a=document.querySelector("#my-screen");d.onclick=function(){return c(this,void 0,void 0,(function*(){try{d.disabled=!0;const e=new s(a);yield e.joinRoom("hoge"),e.onTrack=(e,t)=>{const n="#partner-"+e,i=document.getElementById(n);null==i||i.parentNode.removeChild(i);const o=document.createElement("video");o.id=n,o.setAttribute("autoplay","true"),o.setAttribute("playsinline","true"),o.setAttribute("muted","true"),document.querySelector("#partners").appendChild(o),o.srcObject=t,o.volume=0},e.onLeave=e=>{const t="#partner-"+e,n=document.getElementById(t);null==n||n.parentNode.removeChild(n)}}catch(e){console.error(e)}}))}}]);